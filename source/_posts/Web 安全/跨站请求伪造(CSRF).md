---
title: 跨站请求伪造 (CSRF)
categories: Web 安全
tags: [web 安全]
date: 2021-01-14 15:41:00
---

# 跨站请求伪造 (CSRF)

跨站请求伪造 （Cross-Site Request Forgery ，简称为 CRFR/XSRF)

说明：攻击者盗取用户的身份信息，以用户的名义进行恶意操作（数据查询、转账、删除等）

原理：CSRF 攻击是源于 WEB 的隐式身份验证机制（几乎都是使用 Cookie 来识别用户身份以及保存会话状态）。WEB 的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器，但却无法保证该请求是用户批准发送的，因为服务器并不知道 Get、Post 请求是从哪个页面发出，而浏览器默认给每个请求添加 Cookie 信息。

> note: 同源策略仅仅阻止了第三方站点读取来自其他站点的内容，但是却没有防止这些第三方站点向其他站点发出请求。因为 CSRF 攻击是由于某些请求被发出（而引起在服务器端执行了某些动作）所引起的，所以同源策略只能用来保护第三方站点上的数据的私密性，但是同源策略无法防止 CSRF 攻击。

![CSFR](/images/CSRF.jpg)

完成 CSFR 攻击必须有以下两个步骤:

1. 登录受信任网站A，并生成 Cookie
2. 在网站 A Cookie 有效期间，登录危险网站 B
    * 关闭tab页面或浏览器，并不能结束 Session （Cookie 中的 sessionId依然有效，重新登录时会复写）
    * 危险网站B可能是存在漏洞并受到攻击（XSS 攻击）的大型知名网站
  
**CSFR 防御 **（主要在服务器端完成）
1. 生成随机 `Token`，提交表单时服务器会进行对比 （推荐）
2. 在后端返回 HTML或用户登录后，将 CSFR 令牌（Token）存放在 `Token` 中，之后的请求再将 `Token` 放在请求头 (如 `x-csfr-token`) 中 (推荐)
3. 表单中添加图片验证码
4. 在每个表单中包含一个伪随机数
5. 检查请求头中的 `referer` 字段，并不一定会带上该字段（可用户图片防盗链，只允许站内使用）
6. 使用 `Same-Site` 属性
