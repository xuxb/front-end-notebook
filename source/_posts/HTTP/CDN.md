---
title: CDN
categories: HTTP
tags: [HTTP]
date: 2021-01-14 15:38:00
---

# CDN

## 1. 基本原理

CDN 是将源站内容分发至最接近用户的节点，使用户可就近取得所需内容，提高用户访问的响应速度和成功率。解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点加速、点播、直播等场景。

最简单的CDN 网络由一个 DNS 服务器和几台缓存服务器组成：
1. 当用户点击网站页面上的内容URL，经过本地 DNS 系统解析， DNS 系统会最终将域名的解析权交给CNAME指向的CDN 专用 DNS 服务器。
2. CDN 的 DNS 服务器将CDN 的全局负载均衡设备 IP 地址返回用户。
3. 用户向 CDN 的全局负载均衡设备发起内容 URL 访问请求。
4. CDN 全局负载均衡设备根据用户IP地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。
5. 区域负载均衡设备会为用户选择一台合适的缓存服务器提供服务，选择的依据包括：根据用户IP地址，判断哪一台服务器距用户最近；根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需内容；查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。基于以上这些条件的综合分析之后，区域负载均衡设备会向全局负载均衡设备返回一台缓存服务器的 IP 地址。
6. 全局负载均衡设备把服务器的IP地址返回给用户。
7. 用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。

![CDN 网络基本组件](https://pic4.zhimg.com/80/v2-7d4409a2d13943df2ca9c15defaec8c6_720w.jpg)

## 2. 优点
1. 实现跨运营商、跨地域的全网覆盖
2. 保障网站安全、增强可靠性，防止网络攻击
3. 异地备份
4. 节约成本投入（人力、财力）

> 当网站更新时，如果 CDN 节点上数据没有及时更新，即便用户再浏览器使用 `Ctrl +F5` 的方式使浏览器端的缓存失效，也会因为 CDN 边缘节点没有同步最新数据而导致用户访问异常

## 3. 应用场景
1. 网站站点/应用加速
2. 视音频点播/大文件下载分发加速
3. 移动应用加速

**CDN 执行响应的基本流程**：用户的请求到达边缘服务器时，如果发现可用的缓存，则直接以缓存的内容响应，称为**命中缓存**，否则，请求将在 CDN 内部上行，直到命中合适的缓存或抵达内容网站自有的服务器，由其进行响应，称为**回源**，**源服务器** 处理完回源请求后，其响应将循原路返回，途中，CDN 各级节点将按照约定的方式对其进行缓存，以备下次使用。这是 。


## 4. 常见操作

### 4.1 CDN 回源

常规的 CDN 都是回源的。即当有用户访问某一个 URL 的时候，如果被解析到的那个 CDN 节点没有缓存响应的内容，或者是缓存已经到期，就会回源站去获取。如果没有人访问，那么 CDN 节点不会主动去源站拿的。

> 源站内容有更新的时候，源站主动把内容推送到 CDN 节点

### 4.2 缓存刷新
**缓存刷新**是指淘汰 CDN 节点上的旧文件，重新获取文件的新版本

CDN 节点缓存的资源没有过期，但是基于客户的业务要求，需要更新CDN节点上缓存资源，刷新就是强制删除CDN节点缓存内容。用户请求这些资源时，CDN 节点需要重新回源拉取资源，保证响应的资源与源站一致。

刷新类型分为**目录刷新**和**URL刷新**。URL刷新是直接将节点上缓存的资源删除。对于目录刷新，会将节点上的文件资源过期，会同源站对比 Last-Modified 时间

### 4.3 缓存预热
**缓存预热**是指首次发布的文件，主动从源站推送到 CDN，让用户访问到 CDN 时不用回客户的源站命中。

正常情况下，首批下载的用户体验很差，因为都集中访问源站主机，源站主机的CPU利用率和带宽会跑的很高。第一批用户下载完成后，CDN 中也能够缓存了一份，第二批用户下载就直接在 CDN 中命中，速度比第一批快得多

通过预热功能，将资源从源站推送到各 CDN 节点，提前先缓存起来。等正式使用时第一批用户也能从 CDN 中快速获取到资源


## 5. 常见名称
**A记录**：是用来指定主机名（或域名）对应的IP地址记录。用户可以将该域名下的网站服务器指向到自己的 web server 上。

**CNAME记录**：即：`别名记录`，这种记录允许您将多个名字映射到另外一个域名。

**Origin Server**：即源站，是 CDN 之前的客户真正的服务器。

**CDN 节点**：也称作边缘节点、Cache节点等，是相对于网络的复杂结构而提出的一个概念，指距离最终用户接入具有较少的中间环节的网络节点，对最终接入用户有较好的响应能力和连接速度。其作用是将访问量较大的网页内容和对象保存在服务器前端的专用cache设备上，以此来提高网站访问的速度和质量。

> 用户向浏览器提供要访问的域名，浏览器对域名进行解析，由于 CDN 参与后，对域名解析过程进行了调整，解析的结果不再一个IP地址，而是该域名对应的 CNAME 。但 CNAME 无法完成最终内容的获取，所以，浏览器需要再次对获得的 CNAME 进行解析，以得到实际的 IP 地址。在此过程中，CDN会根据用户的实际地理位置信息解析对应的 IP 地址，使得用户能就近访问。这个过程中， CNAME的主要作用是配合CDN的负载均衡系统将CNAME背后对应的节点IP分配给不同的用户去访问。